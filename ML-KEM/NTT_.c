#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "NTT_.h"
#include "parameter.h"


int zeta[256] = {
    1, 17, 289, 1584, 296, 1703, 2319, 2804, 1062, 1409,
    650, 1063, 1426, 939, 2647, 1722, 2642, 1637, 1197, 375,
    3046, 1847, 1438, 1143, 2786, 756, 2865, 2099, 2393, 733,
    2474, 2110, 2580, 583, 3253, 2037, 1339, 2789, 807, 403,
    193, 3281, 2513, 2773, 535, 2437, 1481, 1874, 1897, 2288,
    2277, 2090, 2240, 1461, 1534, 2775, 569, 3015, 1320, 2466,
    1974, 268, 1227, 885, 1729, 2761, 331, 2298, 2447, 1651,
    1435, 1092, 1919, 2662, 1977, 319, 2094, 2308, 2617, 1212,
    630, 723, 2304, 2549, 56, 952, 2868, 2150, 3260, 2156,
    33, 561, 2879, 2337, 3110, 2935, 3289, 2649, 1756, 3220,
    1476, 1789, 452, 1026, 797, 233, 632, 757, 2882, 2388,
    648, 1029, 848, 1100, 2055, 1645, 1333, 2687, 2402, 886,
    1746, 3050, 1915, 2594, 821, 641, 910, 2154, 3328, 3312,
    3040, 1745, 3033, 1626, 1010, 525, 2267, 1920, 2679, 2266,
    1903, 2390, 682, 1607, 687, 1692, 2132, 2954, 283, 1482,
    1891, 2186, 543, 2573, 464, 1230, 936, 2596, 855, 1219,
    749, 2746, 76, 1292, 1990, 540, 2522, 2926, 3136, 48, 816,
    556, 2794, 892, 1848, 1455, 1432, 1041, 1052, 1239, 1089,
    1868, 1795, 554, 2760, 314, 2009, 863, 1355, 3061, 2102,
    2444, 1600, 568, 2998, 1031, 882, 1678, 1894, 2237, 1410,
    667, 1352, 3010, 1235, 1021, 712, 2117, 2699, 2606, 1025,
    780, 3273, 2377, 461, 1179, 69, 1173, 3296, 2768, 450,
    992, 219, 394, 40, 680, 1573, 109, 1853, 1540, 2877,
    2303, 2532, 3096, 2697, 2572, 447, 941, 2681, 2300, 2481,
    2229, 1274, 1684, 1996, 642, 927, 2443, 1583, 279, 1414,
    735, 2508, 2688, 2419, 1175
};


int* GenZeta() {
    return zeta;
}

//비트 반전 함수
int bit_rev(int x) {
    int t[7] = { 0 };
    for (int i = 0; i < 7; i++) {
        t[i] = x % 2;
        x /= 2;
    }
    int r = 0;
    int j = 1;
    for (int i = 0; i < 7;i++) {
        r = r + t[6 - i] * j;
        j *= 2;
    }
    return r;
}

void NTT(int* f, int* g, int* zeta) {//input, output, zeta
    memcpy(g, f, n * sizeof(int));
    int i = 1;
    int t = 0;
    for (int len = n / 2;len >= 2;len = len / 2) {
        for (int start = 0;start < n;start = start + (2 * len)) {
            int z = zeta[bit_rev(i)];
            i++;
            for (int j = start;j < start + len;j++) {
                t = (z * g[j + len]) % q;
                g[j + len] = (g[j] - t) % q;
                g[j] = (g[j] + t) % q;
            }
        }
    }
    for (int i = 0;i < n;i++) {
        g[i] = g[i] % q;
        while (g[i] < 0) {
            g[i] = g[i] + q;
        }
    }
    return;
}


void NTT_inv(int* f, int* g, int* zeta) {
    memcpy(g, f, n * sizeof(int));
    int i = 127;
    for (int len = 2;len <= 128;len = len * 2) {
        for (int start = 0;start < n;start = start + (2 * len)) {
            int z = zeta[bit_rev(i)];
            i--;
            for (int j = start;j < start + len;j++) {
                int t = g[j];
                g[j] = (t +g[j + len]) % q;
                g[j + len] = (z * (g[j + len] - t)) % q;
            }
        }
    }
    for (int i = 0;i < n;i++) {
        g[i] = (g[i] * 3303) % q;
        while (g[i] < 0) {
            g[i] = g[i] + q;
        }
    }
    return;
}

void Multiply_basic(int a0, int a1, int  b0, int b1, int* c0, int* c1, int r) {
    *c0 = (a0 * b0 + (a1 * b1 % q) * r) % q;
    *c1 = (a0 * b1 + a1 * b0) % q;
    return;
}

void Multiply_NTT(int* f, int* g, int* h, int* zeta) {
    for (int i = 0;i < 128;i++) {
        Multiply_basic(f[2 * i], f[2 * i + 1], g[2 * i], g[2 * i + 1], &h[2 * i], &h[2 * i + 1], zeta[(2 * bit_rev(i)) + 1]);
    }
    return;
}

